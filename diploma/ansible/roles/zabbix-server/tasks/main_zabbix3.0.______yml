---
- name: Update package cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install PostgreSQL server and client
  apt:
    name:
      - postgresql
      - postgresql-client
      - python3-psycopg2
    state: present

- name: Ensure PostgreSQL is running
  systemd:
    name: postgresql
    state: started
    enabled: yes

- name: Create PostgreSQL user and database
  become_user: postgres
  postgresql_user:
    name: "{{ zabbix_db_user }}"
    password: "{{ zabbix_db_password }}"
    role_attr_flags: "CREATEDB,LOGIN"
    state: present

- name: Create Zabbix database
  become_user: postgres
  postgresql_db:
    name: "{{ zabbix_db_name }}"
    owner: "{{ zabbix_db_user }}"
    encoding: UTF8
    state: present

- name: Install Apache
  apt:
    name: apache2
    state: present

- name: Install PHP and extensions
  apt:
    name:
      - php7.2
      - php7.2-pgsql
      - php7.2-gd
      - php7.2-xml
      - php7.2-bcmath
      - php7.2-mbstring
      - php7.2-ldap
    state: present

- name: Install Zabbix Server
  apt:
    name: zabbix-server-pgsql
    state: present

- name: Install Zabbix Frontend
  apt:
    name: zabbix-frontend-php
    state: present

- name: Enable Apache modules
  command: a2enmod {{ item }}
  with_items:
    - rewrite
    - ssl
    - headers
  notify: restart apache2

- name: Create Zabbix log directory
  file:
    path: /var/log/zabbix
    state: directory
    owner: zabbix
    group: zabbix
    mode: 0755

- name: Create Zabbix run directory
  file:
    path: /var/run/zabbix
    state: directory
    owner: zabbix
    group: zabbix
    mode: 0755

- name: Import Zabbix schema
  become_user: postgres
  shell: |
    for file in /usr/share/zabbix-server-pgsql/*.sql.gz; do
      echo "Importing $file"
      zcat "$file" | PGPASSWORD="{{ zabbix_db_password }}" psql -h localhost -U "{{ zabbix_db_user }}" -d "{{ zabbix_db_name }}"
    done
  args:
    executable: /bin/bash

- name: Create Zabbix configuration directory
  file:
    path: /etc/zabbix
    state: directory
    mode: 0755

- name: Configure Zabbix Server
  template:
    src: zabbix_server.conf.j2
    dest: /etc/zabbix/zabbix_server.conf
    owner: root
    group: zabbix
    mode: 0640
  notify: restart zabbix-server

- name: Create PHP configuration for Zabbix
  copy:
    content: |
      max_execution_time=300
      memory_limit=128M
      post_max_size=16M
      upload_max_filesize=2M
      max_input_time=300
      max_input_vars=10000
      always_populate_raw_post_data=-1
      date.timezone=Europe/Moscow
    dest: /etc/php/7.2/apache2/conf.d/99-zabbix.ini
  notify: restart apache2

- name: Configure Apache for Zabbix
  copy:
    content: |
      Alias /zabbix /usr/share/zabbix

      <Directory "/usr/share/zabbix">
          Options FollowSymLinks
          AllowOverride None
          Require all granted

          <IfModule mod_php7.c>
              php_value max_execution_time 300
              php_value memory_limit 128M
              php_value post_max_size 16M
              php_value upload_max_filesize 2M
              php_value max_input_time 300
              php_value max_input_vars 10000
              php_value always_populate_raw_post_data -1
              php_value date.timezone Europe/Moscow
          </IfModule>
      </Directory>

      <Directory "/usr/share/zabbix/conf">
          Require all denied
      </Directory>

      <Directory "/usr/share/zabbix/app">
          Require all denied
      </Directory>

      <Directory "/usr/share/zabbix/include">
          Require all denied
      </Directory>

      <Directory "/usr/share/zabbix/local">
          Require all denied
      </Directory>
    dest: /etc/apache2/conf-available/zabbix.conf
  notify: restart apache2

- name: Enable Zabbix configuration in Apache
  command: a2enconf zabbix
  notify: restart apache2

- name: Ensure Apache is running
  service:
    name: apache2
    state: started
    enabled: yes

- name: Ensure Zabbix Server is running
  service:
    name: zabbix-server
    state: started
    enabled: yes



- name: Wait for Zabbix Server to start
  wait_for:
    port: 10051
    host: "127.0.0.1"
    timeout: 60
    delay: 5

- name: Check Zabbix Server status
  systemd:
    name: zabbix-server
    state: started